name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          python -m pip install pytest numpy pandas matplotlib joblib scikit-learn xgboost folium usaddress PySide6

      - name: Syntax check (compileall)
        run: |
          python -m compileall -q codeAZ

      - name: Smoke imports + API checks
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          python - <<'PY'
          import importlib

          modules = [
              "codeAZ.apli",
              "codeAZ.tab_corr",
              "codeAZ.tab_explore",
              "codeAZ.tab_map",
              "codeAZ.tab_predict",
              "codeAZ.prediction",
              "codeAZ.model",
          ]

          failed = []
          for m in modules:
              try:
                  importlib.import_module(m)
                  print(f"[OK] import {m}")
              except Exception as e:
                  failed.append((m, repr(e)))
                  print(f"[FAIL] import {m}: {e!r}")

          def must_have(modname, names):
              mod = importlib.import_module(modname)
              for n in names:
                  if not hasattr(mod, n):
                      raise AssertionError(f"{modname} missing: {n}")

          must_have("codeAZ.tab_corr", ["CorrelationTab"])
          must_have("codeAZ.tab_map", ["MapTab", "CartographyDynamic"])
          must_have("codeAZ.tab_explore", ["ExplorationTabWidget", "ExplorationTab", "PandasModel", "RealEstateFilterProxy"])
          must_have("codeAZ.tab_predict", ["PredictorTab"])

          if failed:
              raise SystemExit(f"Import failures: {failed}")

          print("All imports and API checks passed.")
          PY

      - name: Run pytest
        run: |
          pytest -q || echo "No tests yet"
